# ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

EpisodicRAGãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨
ãƒªã‚«ãƒãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚

> **å¯¾è±¡èª­è€…**: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆClaude Codeï¼‰ã€äººé–“é–‹ç™ºè€…
> **æƒ³å®šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…æ™‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³å‚ç…§ã€æ—¢å­˜å®Ÿè£…ã®ç†è§£

## ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„

1. **æ—¢å­˜å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¬æ˜**: EpisodicRAGã§æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè£…ä¾‹
2. **ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®æç¤º**: æ–°è¦å®Ÿè£…æ™‚ã«å‚è€ƒã¨ãªã‚‹æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
3. **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨ã®å¯¾å¿œ**: å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å‚ç…§

---

## ç›®æ¬¡

**åŸºæœ¬ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**
- [1. ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚¨ãƒ©ãƒ¼](#1-ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚¨ãƒ©ãƒ¼)
- [2. ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚¨ãƒ©ãƒ¼](#2-ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚¨ãƒ©ãƒ¼)
- [3. JSONç ´æãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼](#3-jsonç ´æãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼)
- [4. ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ã‚¨ãƒ©ãƒ¼](#4-ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ã‚¨ãƒ©ãƒ¼)
- [5. ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼](#5-ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼)
- [6. åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼](#6-åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼)
- [7. å¢ƒç•Œå€¤ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹](#7-å¢ƒç•Œå€¤ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹)

**å®Ÿè£…ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**
- [8. JSONèª­ã¿è¾¼ã¿é–¢æ•°ã®ä½¿ã„åˆ†ã‘](#8-jsonèª­ã¿è¾¼ã¿é–¢æ•°ã®ä½¿ã„åˆ†ã‘)
- [9. Strategy / Chain of Responsibility ãƒ‘ã‚¿ãƒ¼ãƒ³](#9-strategy--chain-of-responsibility-ãƒ‘ã‚¿ãƒ¼ãƒ³)
- [10. ã‚¹ã‚­ãƒ« CLI ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³](#10-ã‚¹ã‚­ãƒ«-cli-ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³)

**ã‚·ã‚¹ãƒ†ãƒ æ§‹é€ **
- [11. å¤–éƒ¨ãƒ‘ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡](#11-å¤–éƒ¨ãƒ‘ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)
- [12. ä¾‹å¤–éšå±¤](#12-ä¾‹å¤–éšå±¤)
- [13. å‚ç…§](#13-å‚ç…§)

---

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€`infrastructure/json_repository/`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŠã‚ˆã³
é–¢é€£ãƒ†ã‚¹ãƒˆï¼ˆ`test_error_recovery.py`ï¼‰ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£èª¬ã—ã¾ã™ã€‚

---

## 1. ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚¨ãƒ©ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
try:
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(data, f)
except IOError as e:
    raise FileIOError(f"Failed to write {file_path}: {e}") from e
```

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_save_json_permission_denied` - èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿
- `test_load_json_permission_denied` - ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãªã—ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
- `test_save_json_directory_not_writable` - æ›¸ãè¾¼ã¿ä¸å¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- `PermissionError`ã‚’`FileIOError`ã«ãƒ©ãƒƒãƒ—ã—ã¦ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼éšå±¤ã‚’ç¶­æŒ
- Windows/Unixé–“ã®æ¨©é™ãƒ¢ãƒ‡ãƒ«ã®é•ã„ã‚’è€ƒæ…®ï¼ˆãƒ†ã‚¹ãƒˆã§ã¯`skipif`ã‚’ä½¿ç”¨ï¼‰

---

## 2. ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚¨ãƒ©ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# OSError 28 = ENOSPC (No space left on device)
try:
    save_json(file_path, data)
except OSError as e:
    if e.errno == 28:
        # ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³ã®å‡¦ç†
        raise FileIOError(f"Disk full: {e}") from e
```

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_save_json_disk_full_simulation` - ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `test_save_json_io_error_simulation` - ä¸€èˆ¬çš„ãªI/Oã‚¨ãƒ©ãƒ¼

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- æœ¬ç•ªç’°å¢ƒã§ã¯äº‹å‰ã«ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’ãƒã‚§ãƒƒã‚¯
- å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿å‰ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨

---

## 3. JSONç ´æãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
def safe_read_json(file_path: Path, raise_on_error: bool = True) -> Optional[Dict[str, Any]]:
    """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«èª­ã¿è¾¼ã‚€å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼"""
    formatter = get_error_formatter()
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except json.JSONDecodeError as e:
        if raise_on_error:
            raise FileIOError(formatter.file.invalid_json(file_path, e)) from e
        return None
    except IOError as e:
        if raise_on_error:
            raise FileIOError(formatter.file.file_io_error("read", file_path, e)) from e
        return None
```

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_load_json_invalid_json` - ä¸æ­£ãªJSONæ§‹æ–‡
- `test_load_json_empty_file` - ç©ºãƒ•ã‚¡ã‚¤ãƒ«
- `test_load_json_truncated` - é€”ä¸­ã§åˆ‡ã‚ŒãŸJSON
- `test_load_json_binary_content` - ãƒã‚¤ãƒŠãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- `json.JSONDecodeError`ã‚’æ˜ç¤ºçš„ã«ã‚­ãƒ£ãƒƒãƒ
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨å…ƒã®ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚ã‚‹
- ãƒãƒƒãƒå‡¦ç†ã§ã¯`raise_on_error=False`ã§ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ã«

---

## 4. ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ã‚¨ãƒ©ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
def load_json(file_path: Path) -> Dict[str, Any]:
    if not file_path.exists():
        raise FileIOError(f"File not found: {file_path}")
    # ...
```

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_load_json_nonexistent` - å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«
- `test_load_json_directory_instead_of_file` - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æŒ‡å®š

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œå‰ã«`exists()`ãƒã‚§ãƒƒã‚¯
- æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒ‘ã‚¹ã‚’å«ã‚ã‚‹

---

## 5. ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# å¸¸ã«UTF-8ã‚’ä½¿ç”¨
with open(file_path, 'r', encoding='utf-8') as f:
    return json.load(f)
```

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_load_json_utf8_bom` - UTF-8 BOMä»˜ããƒ•ã‚¡ã‚¤ãƒ«
- `test_load_json_utf16` - UTF-16ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«
- `test_save_and_load_unicode` - Unicodeæ–‡å­—ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- å¸¸ã«`encoding='utf-8'`ã‚’æ˜ç¤º
- `ensure_ascii=False`ã§æ—¥æœ¬èªãªã©ã‚’æ­£ã—ãä¿å­˜
- BOMä»˜ããƒ•ã‚¡ã‚¤ãƒ«ã¯åˆ¥é€”å‡¦ç†ãŒå¿…è¦

---

## 6. åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯æ¤œå‡º
# Windows: OSError with errno 32 (ERROR_SHARING_VIOLATION)
try:
    save_json(file_path, data)
except OSError as e:
    if e.errno == 32:  # Windows: sharing violation
        # ãƒªãƒˆãƒ©ã‚¤ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼å ±å‘Š
        raise FileIOError(f"File is locked: {file_path}") from e
```

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_save_json_file_locked_simulation` - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ç”¨ã‚’æ¤œè¨ï¼ˆ`filelock`ç­‰ï¼‰
- ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿å¾Œã«ãƒªãƒãƒ¼ãƒ ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰

---

## 7. å¢ƒç•Œå€¤ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

### å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ

- `test_save_and_load_empty_dict` - ç©ºã®dict
- `test_save_and_load_nested_structure` - æ·±ããƒã‚¹ãƒˆã—ãŸæ§‹é€ 
- `test_save_and_load_large_list` - å¤§ããªãƒªã‚¹ãƒˆï¼ˆ10000è¦ç´ ï¼‰
- `test_save_and_load_special_keys` - ç‰¹æ®Šãªã‚­ãƒ¼åï¼ˆç©ºæ–‡å­—ã€ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚¿ãƒ–ï¼‰

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- ç©ºãƒ‡ãƒ¼ã‚¿ã‚‚æœ‰åŠ¹ãªã‚±ãƒ¼ã‚¹ã¨ã—ã¦å‡¦ç†
- æ·±ã„ãƒã‚¹ãƒˆã‚„å¤§ããªãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨ã«æ³¨æ„
- ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ã‚­ãƒ¼ã‚‚æ­£ã—ãå‡¦ç†

---

## 8. JSONèª­ã¿è¾¼ã¿é–¢æ•°ã®ä½¿ã„åˆ†ã‘

| é–¢æ•° | ç”¨é€” | ã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œ |
|------|------|----------------|
| `safe_read_json()` | å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ | `raise_on_error`ã§åˆ¶å¾¡ |
| `load_json()` | å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ | ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ |
| `try_load_json()` | ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”å´ |
| `try_read_json_from_file()` | ãƒãƒƒãƒå‡¦ç†å‘ã‘ | None/ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¿”å´ |
| `load_json_with_template()` | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä»˜ã | 3æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

### ä½¿ç”¨ä¾‹

```python
# å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç­‰ï¼‰
config = load_json(config_path)  # å¤±æ•—æ™‚ã¯ä¾‹å¤–

# ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç­‰ï¼‰
cache = try_load_json(cache_path, default={})  # å¤±æ•—æ™‚ã¯ç©ºdict

# ãƒãƒƒãƒå‡¦ç†
for file in files:
    data = try_read_json_from_file(file)
    if data is None:
        continue  # ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã¸

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä»˜ãèª­ã¿è¾¼ã¿ï¼ˆ3æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
data = load_json_with_template(
    target_file=config_path,
    template_file=template_path,
    default_factory=lambda: {"version": "1.0"},
    save_on_create=True,
)
# 1. æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ« â†’ 2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ â†’ 3. ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°
```

---

## 9. Strategy / Chain of Responsibility ãƒ‘ã‚¿ãƒ¼ãƒ³

`json_repository/`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯2ã¤ã®GoFãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ã€
ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®£è¨€çš„ã«è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚

### LoadStrategy åŸºåº•ã‚¯ãƒ©ã‚¹

```python
class LoadStrategy(ABC, Generic[T]):
    """JSONèª­ã¿è¾¼ã¿æˆ¦ç•¥ã®æŠ½è±¡åŸºåº•ã‚¯ãƒ©ã‚¹"""

    @abstractmethod
    def load(self, context: LoadContext) -> Optional[T]:
        """èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œã€æˆåŠŸæ™‚ã¯Tã€å¤±æ•—æ™‚ã¯None"""
        ...

    @abstractmethod
    def get_description(self) -> str:
        """æˆ¦ç•¥ã®èª¬æ˜ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰"""
        ...
```

### å…·è±¡æˆ¦ç•¥ã‚¯ãƒ©ã‚¹

| ã‚¯ãƒ©ã‚¹ | è²¬å‹™ | è©¦è¡Œé †åº |
|--------|------|----------|
| `FileLoadStrategy` | æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ | 1 |
| `TemplateLoadStrategy` | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰åˆæœŸåŒ– | 2 |
| `FactoryLoadStrategy` | ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°ã‹ã‚‰ç”Ÿæˆ | 3 |
| `DefaultLoadStrategy` | ç©ºdictã‚’è¿”ã™ï¼ˆæœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ | 4 |

### ChainedLoader ã®å‹•ä½œãƒ•ãƒ­ãƒ¼

```python
class ChainedLoader(Generic[T]):
    def load(self, context: LoadContext) -> Optional[T]:
        for strategy in self._strategies:
            logger.debug(f"Trying: {strategy.get_description()}")
            result = strategy.load(context)
            if result is not None:
                return result
        return None
```

### ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ™å‹•

- å„æˆ¦ç•¥å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ `None` ã‚’è¿”ã—ã€æ¬¡ã®æˆ¦ç•¥ã¸
- `FileLoadStrategy` ã§ `raise_on_error=True` ã®å ´åˆã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
- `DefaultLoadStrategy` ãŒæœ€å¾Œã«ã‚ã‚‹ãŸã‚ã€å¿…ãšçµæœãŒè¿”ã‚‹

---

## 10. ã‚¹ã‚­ãƒ« CLI ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

v4.0.0ã§ã‚¹ã‚­ãƒ«ãŒPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã•ã‚Œã€æ§‹é€ åŒ–ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

### SetupResult statusåˆ¥ã‚¨ãƒ©ãƒ¼å‡¦ç† (digest_setup.py)

```python
@dataclass
class SetupResult:
    status: str  # "ok" | "error" | "already_configured"
    created: Optional[Dict[str, Any]] = None
    warnings: List[str] = field(default_factory=list)
    external_paths_detected: List[str] = field(default_factory=list)
    error: Optional[str] = None
```

### ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
result = manager.init(config_data, force=args.force)
if result.status == "error":
    output_error(result.error)
elif result.status == "already_configured":
    # æ—¢å­˜è¨­å®šãŒã‚ã‚‹å ´åˆã®å‡¦ç†
    pass
else:  # "ok"
    output_json(asdict(result))
```

### ConfigEditor ã®ã‚¨ãƒ©ãƒ¼å‡¦ç† (digest_config.py)

```python
# FileNotFoundError: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„
except FileNotFoundError as e:
    output_error(str(e), {"action": "Run @digest-setup first"})

# JSONDecodeError: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æ
except json.JSONDecodeError as e:
    output_error(f"Config file is corrupted: {e}", {"action": "Run @digest-setup to recreate"})
```

---

## 11. å¤–éƒ¨ãƒ‘ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

v4.0.0ã§å°å…¥ã•ã‚ŒãŸ`trusted_external_paths`ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã€‚

### æ¦‚è¦

`config.json`ã®`trusted_external_paths`ã¯ã€æ°¸ç¶šåŒ–ãƒ‘ã‚¹å¤–ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã€‚

### æ°¸ç¶šåŒ–ãƒ‘ã‚¹ *(v5.2.0+)*

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ°¸ç¶šåŒ–ãƒ‘ã‚¹ `~/.claude/plugins/.episodicrag/` ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

```python
from infrastructure.config import get_persistent_config_dir, get_config_path

# æ°¸ç¶šåŒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
config_dir = get_persistent_config_dir()  # ~/.claude/plugins/.episodicrag/

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
config_path = get_config_path()  # ~/.claude/plugins/.episodicrag/config.json
```

### ãƒ‘ã‚¹æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯

```python
def _validate_path_security(self, resolved_path: Path) -> None:
    """ãƒ‘ã‚¹ãŒè¨±å¯ã•ã‚ŒãŸç¯„å›²å†…ã‹ã‚’æ¤œè¨¼"""
    # æ°¸ç¶šåŒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã¯å¸¸ã«è¨±å¯
    persistent_dir = get_persistent_config_dir()
    if self._is_subpath(resolved_path, persistent_dir):
        return

    # trusted_external_paths å†…ã¯è¨±å¯
    for trusted_path in self.trusted_external_paths:
        if self._is_subpath(resolved_path, Path(trusted_path).expanduser()):
            return

    raise ConfigError(f"Access denied: {resolved_path} is outside trusted paths")
```

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- `base_dir` ã¯çµ¶å¯¾ãƒ‘ã‚¹å¿…é ˆï¼ˆv5.2.0+ã€ç›¸å¯¾ãƒ‘ã‚¹ã¯ã‚¨ãƒ©ãƒ¼ï¼‰
- çµ¶å¯¾ãƒ‘ã‚¹ã¾ãŸã¯ `~` ã§å§‹ã¾ã‚‹ãƒ‘ã‚¹ã®ã¿`trusted_external_paths`ã«ç™»éŒ²
- å¤–éƒ¨ãƒ‘ã‚¹æ¤œå‡ºæ™‚ã¯`external_paths_detected`ã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è­¦å‘Š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç©ºé…åˆ—

> ğŸ“– è©³ç´°: [ARCHITECTURE.md](ARCHITECTURE.md#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ)

---

## 12. ä¾‹å¤–éšå±¤

```
EpisodicRAGError (Base exception)
â”œâ”€â”€ ConfigError         (Configuration issues)
â”œâ”€â”€ DigestError         (Digest processing failures)
â”œâ”€â”€ ValidationError     (Input validation failures)
â”œâ”€â”€ FileIOError         (File I/O failures)
â””â”€â”€ CorruptedDataError  (Data integrity issues)
```

---

## 13. å‚ç…§

- å®Ÿè£…: `../../scripts/infrastructure/json_repository/`
  - `operations.py` - åŸºæœ¬æ“ä½œï¼ˆsafe_read_json, load_json, save_jsonç­‰ï¼‰
  - `load_strategy.py` - Strategy Patternå®Ÿè£…
  - `chained_loader.py` - Chain of Responsibilityå®Ÿè£…
- ãƒ†ã‚¹ãƒˆ: `../../scripts/test/integration_tests/test_error_recovery.py`
- ä¾‹å¤–å®šç¾©: `../../scripts/domain/exceptions.py`

---
**EpisodicRAG** by Weave | [GitHub](https://github.com/Bizuayeu/Plugins-Weave)
